<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Pending NSC: Malda Zone</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Google Fonts - Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  <style>
    :root {
      --primary: #4361ee;
      --secondary: #3f37c9;
      --success: #4cc9f0;
      --info: #4895ef;
      --warning: #f72585;
      --danger: #ff006e;
      --light: #f8f9fa;
      --dark: #212529;
      --primary: #4361ee;
      --gradient-1: linear-gradient(to right, #4cc9f0, #4361ee);
      --gradient-2: linear-gradient(to right, #f72585, #ff006e);
      --gradient-3: linear-gradient(to right, #3f37c9, #4361ee);
      --gradient-4: linear-gradient(to right, #b5179e, #f72585);
      --gradient-5: linear-gradient(to right, #2b9348, #55a630); /* Fresh green gradient */

    }


  body {
    padding: 1.5rem;
  }

  .expandable-row td{
    padding: 0.2rem 0.2rem;
    font-size: 0.8rem;
  }
  
  @media (min-width: 992px) {
  .container-fluid {
    max-width: 80%;
    margin: 0 auto;
  }
}

  @media (max-width: 768px) {
    body {
      padding: 0.2rem;
    }
  }



    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f0f2f5;
      color: var(--dark);
    }
    
    .dashboard-header {
      background: var(--gradient-1);
      color: white;
      padding: 1.5rem;
      border-radius: 15px;
      margin-bottom: 2rem;
      box-shadow: 0 10px 20px rgba(67, 97, 238, 0.2);
    }
    
    .dashboard-header h2 {
      margin: 0;
      font-weight: 700;
      letter-spacing: 0.5px;
      font-size: 1.5rem; 
    }
    .col-lg-2-4 {
  flex: 0 0 auto;
  width: 20%;
}

    .card {
      border-radius: 15px;
      border: none;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
      overflow: hidden;
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.12);
    }
    
    .card .card-body {
  padding: 1rem 1.2rem;
}
    
    .kpi-card-1 {
      background: var(--gradient-1);
      color: white;
    }
    
    .kpi-card-2 {
      background: var(--gradient-2);
      color: white;
    }
    
    .kpi-card-3 {
      background: var(--gradient-3);
      color: white;
    }
    
    .kpi-card-4 {
      background: var(--gradient-4);
      color: white;
    }
    .kpi-card-5 {
  background: var(--gradient-5);
  color: white;
}

.kpi-card-count {
  font-size: 1.5rem;
  font-weight: 700;
  margin-bottom: 0.25rem;
}
    
.kpi-card-label {
  font-size: 0.75rem;
  font-weight: 400;
  margin: 0;
  line-height: 1.2;
}
    
.kpi-card-icon {
  top: 0.8rem;
  right: 0.8rem;
  font-size: 1.2rem;
  opacity: 0.4;
}
    
/* Compact Filters */
.filter-card {
  background-color: white;
  border-radius: 10px;
  padding: 0.75rem 1rem;
  margin-bottom: 1rem;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
}

.filter-title {
  font-size: 0.95rem;
  font-weight: 600;
  margin-bottom: 0.4rem;
  color: var(--dark);
}

.form-select {
  border-radius: 8px;
  padding: 0.4rem 0.75rem;
  border: 1px solid #ddd;
  font-size: 0.75rem;
  height: auto;
  line-height: 1.2;
}

.form-select:focus {
  box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.15);
  border-color: var(--primary);
}
    
    .nav-pills {
      background-color: white;
      border-radius: 12px;
      padding: 0.5rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 1.5rem;
    }
    
    .nav-pills .nav-link {
      border-radius: 8px;
      padding: 0.4rem 1.0rem;
      font-size: 0.8rem !important;
      font-weight: 500;
      color: #555;
      margin: 0 0.2rem;
    }
    
    .nav-pills .nav-link.active {
      background-color: var(--primary);
      color: white;
      box-shadow: 0 4px 8px rgba(67, 97, 238, 0.3);
    }
    
    .chart-container {
      position: relative;
      height: 550px;
      background-color: white;
      border-radius: 15px;
      padding: 1.0rem;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
      overflow-y: auto; /* <-- Add this */
      scrollbar-width: thin; /* for Firefox */
    }
    .chart-container::-webkit-scrollbar {
  width: 6px; /* thin scrollbar for Chrome/Safari */
}

.chart-container::-webkit-scrollbar-thumb {
  background-color: rgba(0, 0, 0, 0.2);
  border-radius: 4px;
}
    .detail-table {
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    
    .detail-table .table {
      margin-bottom: 0;
    }
    
    .detail-table thead {
      background-color: #eef2ff;
    }
    
    .detail-table th {
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: 0.5px;
      padding: 0.3rem;
      border: none;
    }
    
    .detail-table td {
      padding: 0.3rem;
      border-color: #eef2ff;
      vertical-align: middle;
    }
    
    .section-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      color: var(--dark);
      position: relative;
      padding-left: 1rem;
    }
    
    .section-title::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 4px;
      background: var(--gradient-1);
      border-radius: 4px;
    }
    
    /* Animation for loading */
    @keyframes pulse {
      0% { opacity: 0.6; }
      50% { opacity: 0.8; }
      100% { opacity: 0.6; }
    }
    
    .loading {
      animation: pulse 1.5s infinite;
      background: #eee;
      border-radius: 8px;
      height: 1.2rem;
      margin: 0.5rem 0;
    }

.blinking-link {
  animation: blinkAnimation 2s infinite;
}

@keyframes blinkAnimation {
  0% { opacity: 1; }
  50% { opacity: 0.4; }
  100% { opacity: 1; }
}
.sub-row table {
  background: #f8f9fa;
  border-left: 4px solid #4361ee;
  margin: 0.5rem 1rem; /* Add margin to left/right */
  width: auto; /* don't force full width */
  font-size: 0.8rem; /* smaller font */
  border-radius: 8px;
  overflow: hidden;
}
.sub-row td, .sub-row th {
  padding: 0.2rem 0.4rem; /* smaller padding */
  white-space: nowrap;
}

.sub-row > td > div {
  overflow-x: auto;
  padding: 0.3rem .6rem; /* add padding inside the div */
}
  .sub-row > td > div {
  overflow-x: auto;
  padding: 0.3rem .6rem; /* Add inner padding too */
}

  .sub-row table thead th {
    background-color: #e3f2fd;
    font-weight: 600;
    font-size: 0.8rem;
  }
  /* Force collapses to auto-expand without animated height */
.collapse {
  display: none !important;
}

.collapse.show {
  display: block !important;
  height: auto !important;
  visibility: visible;
}
h5{
  font-size: 1.2rem;
}

.modal {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}
.modal-content {
  background: white;
  padding: 20px;
  border-radius: 8px;
  width: 90%;
  max-width: 600px;
}
.modal-close {
  position: absolute;
  right: 15px;
  top: 15px;
  cursor: pointer;
  color: red;
}


  </style>
</head>

<body>
  
  <div class="container-fluid">

    <!-- Dashboard Header -->
    <div class="dashboard-header d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2 class="mb-0"><i class="fas fa-tachometer-alt me-2"></i> Pending NSC</h2>
            <div id="reportDateSpan" style="font-size: 0.75rem; color: #ffffff;">Updated on: <span id="reportDate">Loading...</span></div>
        </div>
        <span id="maxDateSpan" style="font-size: 0.75rem; color: #ffe600;"></span>
    </div>
      
    <!-- Filters Row -->
    <div class="filter-card">
      <div class="filter-title"><i class="fas fa-filter me-2"></i>Filters</div>
      <div class="row">
        <div class="col-md-4 mb-3">
          <select id="regionSelect" class="form-select">
            <option value="">Select Region</option>
          </select>
        </div>
        <div class="col-md-4 mb-3">
          <select id="divnSelect" class="form-select">
            <option value="">Select Division</option>
          </select>
        </div>
        <div class="col-md-4 mb-3">
          <select id="suppSelect" class="form-select">
            <option value="">Select CCC</option>
          </select>
        </div>
        <div class="col-md-4 mb-3">
  <select id="poleFilter" class="form-select">
    <option value="">Pole/Non-Pole</option>
    <option value="Pole">Pole</option>
    <option value="Non-Pole">Non-Pole</option>
  </select>
</div>
<div class="col-md-4 mb-3">
  <select id="delayRangeFilter" class="form-select">
    <option value="">Select Delay Range</option>
  </select>
</div>
<div class="col-md-4 mb-3">
  <select id="delayRange2Filter" class="form-select">
    <option value="">Select Delay Range-2</option>
  </select>
</div>

      </div>
    </div>

<!-- Average Delay Group - Compact Version -->
<div class="card p-3 mb-4" style="background-color: #f1f5ff; border-radius: 15px;">
  <h6 class="mb-3 text-center" style="color: #4361ee; font-size: 0.8rem;">
    Average Delay Summary <br>
    <small style="font-size: 0.8rem; color: #666;">(Overall Avg &nbsp; | &nbsp; Pole / Non-Pole)</small>
  </h6>
  
    <div class="row">
      <div class="col-md-4 mb-2">
        <div class="card text-center shadow-sm" style="background-color: #e3f2fd; border-radius: 12px;">
          <div class="card-body p-2">
            <div style="font-size: 0.8rem; font-weight: 500; color: #555;">Avg Delay for Quotation</div>
            <div style="font-size: 1.4rem; font-weight: 700;" id="avgDelayQtn">0</div>
          </div>
        </div>
      </div>
      <div class="col-md-4 mb-2">
        <div class="card text-center shadow-sm" style="background-color: #e3f2fd; border-radius: 12px;">
          <div class="card-body p-2">
            <div style="font-size: 0.8rem; font-weight: 500; color: #555;">Avg Delay for WO</div>
            <div style="font-size: 1.4rem; font-weight: 700;" id="avgDelayWO">0</div>
          </div>
        </div>
      </div>
      <div class="col-md-4 mb-2">
        <div class="card text-center shadow-sm" style="background-color: #e3f2fd; border-radius: 12px;">
          <div class="card-body p-2">
            <div style="font-size: 0.8rem; font-weight: 500; color: #555;">Avg Delay for Connection</div>
            <div style="font-size: 1.4rem; font-weight: 700;" id="avgDelaySC">0</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
    <!-- KPI Cards Row -->
<!-- KPI Cards Row -->
<div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 row-cols-xl-5 g-3 mb-4">

  <!-- Total Pending Card -->
  <div class="col">
    <div class="card kpi-card-1" id="totalPendingCard" style="cursor:pointer;">
      <div class="card-body position-relative">
        <i class="fas fa-clock kpi-card-icon"></i>
        <h2 class="kpi-card-count" id="totalPending">0</h2>
        <p class="kpi-card-label">Total Pending</p>
      </div>
      <div class="collapse" id="totalPendingCollapse">
        <div class="card detail-table" id="totalPendingTableContainer"></div>
      </div>
    </div>
  </div>

  <!-- Non Pole Cases Card -->
  <div class="col">
    <div class="card kpi-card-2" id="nonPoleCard" style="cursor:pointer;">
      <div class="card-body position-relative">
        <i class="fas fa-home kpi-card-icon"></i>
        <h2 class="kpi-card-count" id="nonPole">0</h2>
        <p class="kpi-card-label">Non Pole Cases</p>
      </div>
      <div class="collapse" id="nonPoleCollapse">
        <div class="card detail-table" id="nonPoleTableContainer"></div>
      </div>
    </div>
  </div>

  <!-- Pole Cases Card -->
  <div class="col">
    <div class="card kpi-card-3" id="poleCard" style="cursor:pointer;">
      <div class="card-body position-relative">
        <i class="fas fa-bolt kpi-card-icon"></i>
        <h2 class="kpi-card-count" style="font-size: 1.5rem;">
          <span id="pole">0</span>
          <span class="text-light" id="poleSum" style="font-size: 0.85rem; font-weight: 400; opacity: 0.9;">(0)</span>
        </h2>
        <p class="kpi-card-label" style="font-size: 0.0.75rem;">Pole Cases / Reqd. Pole</p>
        
      </div>
      <div class="collapse" id="poleCollapse">
        <div class="card detail-table" id="poleTableContainer"></div>
      </div>
    </div>
  </div>

  <!-- Industrial Pending Card -->
  <div class="col">
    <div class="card kpi-card-4" id="industrialPendingCard" style="cursor:pointer;">
      <div class="card-body position-relative">
        <i class="fas fa-industry kpi-card-icon"></i>
        <h2 class="kpi-card-count" id="industrialPending">0</h2>
        <p class="kpi-card-label">Industrial Pending</p>
      </div>
      <div class="collapse" id="industrialPendingCollapse">
        <div class="card detail-table" id="industrialPendingTableContainer"></div>
      </div>
    </div>
  </div>

  <!-- Commercial 3-Ph Card -->
  <div class="col">
    <div class="card kpi-card-5" id="commercial3phCard" style="cursor:pointer;">
      <div class="card-body position-relative">
        <i class="fas fa-plug kpi-card-icon"></i>
        <h2 class="kpi-card-count" id="commercial3ph">0</h2>
        <p class="kpi-card-label">Commercial 3-Ph</p>
      </div>
      <div class="collapse" id="commercial3phCollapse">
        <div class="card detail-table" id="commercial3phTableContainer"></div>
      </div>
    </div>
  </div>
<!-- Initially Withheld Card -->
<div class="col">
  <div class="card kpi-card-4" id="initiallyWithheldCard" style="cursor:pointer; background: linear-gradient(to right, #d00000, #ff4d4d); color: white;">
    <div class="card-body position-relative">
      <i class="fas fa-ban kpi-card-icon" style="display: block;"></i>
      
      <h2 class="kpi-card-count" id="initiallyWithheldCount" style="display: inline;">0</h2>
      <p class="text-light" id="initiallyWithheldPercent" style="font-size: 0.9rem; font-weight: 400; opacity: 0.9; margin-top: -10px; display: inline;">
        (0%)
      </p>      
      <p class="kpi-card-label">Initially Withheld</p>
    </div>
    <div class="collapse" id="initiallyWithheldCollapse">
      <div class="card detail-table" id="initiallyWithheldTableContainer"></div>
    </div>
  </div>
</div>

</div>

      

      
<!-- Shared collapse for desktop view -->
<div class="collapse mb-4" id="detailCollapse">
    <div class="card detail-table" id="detailTableContainer"></div>
  </div>
  
    <!-- Detailed Analysis Section -->
    <h2 class="section-title mb-4">Detailed Analysis</h2>
    <ul class="nav nav-pills mb-4" id="pills-tab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="delay-tab" data-bs-toggle="pill" data-bs-target="#delay" type="button" role="tab">
          <i class="fas fa-hourglass-half me-2"></i>Delay Range
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="pole-tab" data-bs-toggle="pill" data-bs-target="#pole-data" type="button" role="tab">
          <i class="fas fa-bolt me-2"></i>Pole/Non-Pole
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="duare-tab" data-bs-toggle="pill" data-bs-target="#duare" type="button" role="tab">
          <i class="fas fa-home me-2"></i>Duare Sarkar
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="wo-tab" data-bs-toggle="pill" data-bs-target="#wo" type="button" role="tab">
          <i class="fas fa-file-contract me-2"></i>WO Status
        </button>
      </li>

      <li class="nav-item" role="presentation">
        <button class="nav-link" id="classwise-tab" data-bs-toggle="pill" data-bs-target="#classwise" type="button" role="tab">
          <i class="fas fa-layer-group me-2"></i>Class Wise
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="agency-tab" data-bs-toggle="pill" data-bs-target="#agency" type="button" role="tab">
          <i class="fas fa-briefcase me-2"></i>Agency Wise
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="delay2-tab" data-bs-toggle="pill" data-bs-target="#delay2" type="button" role="tab">
          <i class="fas fa-hourglass-end me-2"></i>Delay Range-2
        </button>
      </li>
      
    </ul>
    
    <div class="tab-content" id="pills-tabContent">
      <div class="tab-pane fade show active" id="delay" role="tabpanel">
        <div class="chart-container">
          <canvas id="delayChart"></canvas>
        </div>
      </div>
      <div class="tab-pane fade" id="pole-data" role="tabpanel">
        <div class="chart-container">
          <canvas id="poleChart"></canvas>
        </div>
      </div>
      <div class="tab-pane fade" id="duare" role="tabpanel">
        <div class="chart-container">
          <canvas id="duareChart"></canvas>
        </div>
      </div>
      <div class="tab-pane fade" id="wo" role="tabpanel">
        <div class="chart-container">
          <canvas id="woChart"></canvas>
        </div>
      </div>
      <div class="tab-pane fade" id="classwise" role="tabpanel">
        <div class="chart-container">
          <canvas id="classwiseChart"></canvas> <!-- placeholder -->
        </div>
      </div>
      <div class="tab-pane fade" id="agency" role="tabpanel">
        <div class="chart-container">
          <canvas id="agencyChart"></canvas> <!-- Placeholder, replaced by table -->
        </div>
      </div>
      <div class="tab-pane fade" id="delay2" role="tabpanel">
        <div class="chart-container">
          <div id="delayRange2Table"></div>
        </div>
      </div>
      
    </div>
  </div>

  <!-- Bootstrap 5 JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Data URL
    const dataUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRsUU2viBvYhSgR0RFwmZ1H8LkYCats9roQVCKvQeoU7dzg6ryR6IWZex9FT9tksp_DEM23ZgQ28Iyo/pub?output=csv";
    let rawData = [], filteredData = [];
    let charts = {};

    // Helper function to safely parse CSV data
    function parseCsvRow(row, headers) {
      const obj = {};
      row.forEach((val, idx) => {
        if (idx < headers.length) {
          obj[headers[idx]] = val;
        }
      });
      return obj;
    }

    // Fetch and process data
    async function fetchData() {
      try {
        showLoading(true);
        const res = await fetch(dataUrl);
        const text = await res.text();
        const parsed = Papa.parse(text.trim(), {
          header: true,
          skipEmptyLines: true
        });
        rawData = parsed.data;
        filteredData = [...rawData];
        
        // Get report update date from TODAY field in second row (index 1)
        if (rawData && rawData.length > 1 && rawData[1].TODAY) {
          document.getElementById('reportDate').textContent = rawData[1].TODAY;
        } else {
          document.getElementById('reportDate').textContent = "N/A";
        }
        
        populateFilters();
        updateDashboard();
        drawTables(); // instead of drawCharts();
        showLoading(false);
      } catch (error) {
        console.error("Error loading data:", error);
        document.getElementById('totalPending').innerText = "Error";
        document.getElementById('reportDate').textContent = "Error loading data";
        alert("Failed to load data. Please check your internet connection and try again.");
        showLoading(false);
      }
    }

    // Show/hide loading indicators
    function showLoading(isLoading) {
      const elements = ['totalPending', 'nonPole', 'pole', 'industrialPending', 'commercial3ph', 'initiallyWithheldCount'];

  elements.forEach(id => {
    const el = document.getElementById(id);
    if (isLoading) {
      el.innerHTML = '<div class="loading"></div>';
    }
  });
}


    // Populate filter dropdowns with unique values
    function populateFilters() {
  const region = document.getElementById('regionSelect').value;
  const divn = document.getElementById('divnSelect').value;

  // Unique helper
  const unique = (arr, key) => {
    return [...new Set(arr.map(x => x[key]).filter(Boolean).map(v => v.trim()))].sort();
  };

  // First populate Region normally from rawData
  const regions = unique(rawData, 'REGION');
  const regionSelect = document.getElementById('regionSelect');
  const previousRegion = regionSelect.value;
  regionSelect.innerHTML = `<option value="">Select Region</option>`;
  regions.forEach(r => {
    const opt = document.createElement('option');
    opt.value = r;
    opt.textContent = r;
    if (r === previousRegion) opt.selected = true;
    regionSelect.appendChild(opt);
  });

  // Populate Division based on selected Region
  let divns = rawData;
  if (region) {
    divns = rawData.filter(d => d.REGION === region);
  }
  const divisions = unique(divns, 'DIVN_NAME');
  const divnSelect = document.getElementById('divnSelect');
  const previousDivn = divnSelect.value;
  divnSelect.innerHTML = `<option value="">Select Division</option>`;
  divisions.forEach(d => {
    const opt = document.createElement('option');
    opt.value = d;
    opt.textContent = d;
    if (d === previousDivn) opt.selected = true;
    divnSelect.appendChild(opt);
  });

  // Populate Office based on selected Division
  let supps = rawData;
  if (divn) {
    supps = rawData.filter(d => d.DIVN_NAME === divn);
  } else if (region) {
    supps = rawData.filter(d => d.REGION === region);
  }
  const offices = unique(supps, 'SUPP_OFF');
  const suppSelect = document.getElementById('suppSelect');
  const previousSupp = suppSelect.value;
  suppSelect.innerHTML = `<option value="">Select CCC</option>`;
  offices.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s;
    opt.textContent = s;
    if (s === previousSupp) opt.selected = true;
    suppSelect.appendChild(opt);
  });

  // Populate Delay Range
// Sort Delay Ranges based on DelaySerial
const delayRangeMap = {};
rawData.forEach(d => {
  const range = d.DelayRange;
  const serial = parseInt(d.DelaySerial);
  if (range && !delayRangeMap[range]) {
    delayRangeMap[range] = serial;
  }
});
// Delay Range-2 Buckets
const delayRange2Options = [
  "Within 3 days",
  "More than 3 days",
  "More than 7 days",
  "More than 15 days",
  "More than 1 month",
  "More than 2 month",
  "More than 6 month",
  "More than 1 year"
];

const delay2Select = document.getElementById('delayRange2Filter');
const previousDelay2 = delay2Select.value;
delay2Select.innerHTML = `<option value="">Select Delay Range-2</option>`;
delayRange2Options.forEach(r => {
  const opt = document.createElement('option');
  opt.value = r;
  opt.textContent = r;
  if (r === previousDelay2) opt.selected = true;
  delay2Select.appendChild(opt);
});

const delayRangesSorted = Object.entries(delayRangeMap)
.sort((a, b) => b[1] - a[1])  // reverse order
  .map(entry => entry[0]);

const delaySelect = document.getElementById('delayRangeFilter');
const previousDelay = delaySelect.value;
delaySelect.innerHTML = `<option value="">Select Delay Range</option>`;
delayRangesSorted.forEach(r => {
  const opt = document.createElement('option');
  opt.value = r;
  opt.textContent = r;
  if (r === previousDelay) opt.selected = true;
  delaySelect.appendChild(opt);
});


}

function applyFilters() {
  const region = document.getElementById('regionSelect').value;
  const divn = document.getElementById('divnSelect').value;
  const supp = document.getElementById('suppSelect').value;
  const poleType = document.getElementById('poleFilter').value;
  const delayRange = document.getElementById('delayRangeFilter').value;
  const delayRange2 = document.getElementById('delayRange2Filter').value;




  // 1. Filter the raw data based on selected filters
  filteredData = rawData.filter(d => 
    (region === "" || d.REGION === region) &&
    (divn === "" || d.DIVN_NAME === divn) &&
    (supp === "" || d.SUPP_OFF === supp)
    && (poleType === "" || 
     (poleType === "Pole" && d.NO_OF_POLES && d.NO_OF_POLES.trim() !== "" && d.NO_OF_POLES !== "0") ||
     (poleType === "Non-Pole" && (!d.NO_OF_POLES || d.NO_OF_POLES.trim() === "" || d.NO_OF_POLES === "0")))
     && (delayRange === "" || d.DelayRange === delayRange)
     && (delayRange2 === "" || isInDelayRange2(d, delayRange2))

  );
  function isInDelayRange2(d, selectedRange) {
  const serial = parseInt(d.DelaySerial);
  if (isNaN(serial)) return false;

  const ranges = {
    "Within 3 days": [1],
    "More than 3 days": [2,3,4,5,6,7,8],
    "More than 7 days": [3,4,5,6,7,8],
    "More than 15 days": [4,5,6,7,8],
    "More than 1 month": [5,6,7,8],
    "More than 2 month": [6,7,8],
    "More than 6 month": [7,8],
    "More than 1 year": [8]
  };

  return ranges[selectedRange]?.includes(serial);
}

  // 2. Repopulate dropdown filters (keep earlier selections if possible)
  populateFilters(); 

  // 3. Collapse all expanded sub-rows (KPI and tabbed tables)
  document.querySelectorAll('.sub-row').forEach(row => {
    row.style.display = "none";
  });
  document.querySelectorAll('.expandable-row i').forEach(icon => {
    icon.classList.remove('fa-chevron-down');
    icon.classList.add('fa-chevron-right');
  });

  // 4. Update KPI Cards (counts and averages)
  updateDashboard();

  // 5. Redraw all tables (includes tabbed tables and card tables)
  drawTables();
}





    // Add option to select element
    function addOption(id, value) {
      const sel = document.getElementById(id);
      const opt = document.createElement('option');
      opt.value = value;
      opt.textContent = value;
      sel.appendChild(opt);
    }

    // Update dashboard with filtered data
    function updateDashboard() {
      // Debug logging for CONN_CLASS values
      console.log("CONN_CLASS values sample:", 
        filteredData.slice(0, 10).map(d => ({
          original: d.CONN_CLASS,
          normalized: (d.CONN_CLASS || "").trim().toUpperCase()
        }))
      );
      
      // Total Pending count
      document.getElementById('totalPending').textContent = filteredData.length;

      // Non Pole Case count (where NO_OF_POLES is blank or null or 0)
      const nonPoleCases = filteredData.filter(d => {
        const poles = d.NO_OF_POLES || "";  
        return poles.trim() === "" || poles === "0";
      }).length;

      // Pole Case count (where NO_OF_POLES has value greater than 0)
      const poleCases = filteredData.filter(d => {
        const poles = d.NO_OF_POLES || "";
        return poles.trim() !== "" && poles !== "0";
      }).length;

      var temp = 0;
      var temp2 = 0;
      var temp3 = [];
      // Industrial Pending count (where CONN_CLASS is exactly "I")
      const industrialPending = filteredData.filter(d => {
        const connClass = (d.CONN_CLASS || "").trim().toUpperCase();
        //console.log(connClass, d.CONN_CLASS, connClass === "I");
        if (connClass === "I") {
          temp++;
          console.log(d);
          temp3.push(d.APPL_NO);
        }else{
            temp2++;
        }
        return connClass === "I";
      }).length;


      // Update the counts
      document.getElementById('nonPole').textContent = nonPoleCases;
      document.getElementById('pole').textContent = poleCases;
      const totalPoles = filteredData
  .filter(d => {
    const poles = d.NO_OF_POLES || "";
    return poles.trim() !== "" && poles !== "0";
  })
  .reduce((sum, d) => sum + (parseInt(d.NO_OF_POLES) || 0), 0);

document.getElementById('poleSum').textContent = `(${totalPoles})`;


      document.getElementById('industrialPending').textContent = industrialPending;

      // Calculate averages for delays
function average(arr, key) {
  const nums = arr.map(d => parseFloat(d[key]) || 0).filter(n => n > 0);
  if (nums.length === 0) return 0;
  const sum = nums.reduce((a, b) => a + b, 0);
  return (sum / nums.length).toFixed(1);
}

// Helper: Pole / Non-Pole filter
const isPole = d => (d.NO_OF_POLES || "").trim() !== "" && d.NO_OF_POLES !== "0";
const isNonPole = d => (d.NO_OF_POLES || "").trim() === "" || d.NO_OF_POLES === "0";

// Main
const avgQtn = average(filteredData, 'DelayInQtn');
const avgWO = average(filteredData, 'DelayInWO');
const avgSC = average(filteredData, 'DelayInSC');

// Pole
const poleData = filteredData.filter(isPole);
const avgQtnPole = average(poleData, 'DelayInQtn');
const avgWOPole = average(poleData, 'DelayInWO');
const avgSCPole = average(poleData, 'DelayInSC');

// Non-Pole
const nonPoleData = filteredData.filter(isNonPole);
const avgQtnNonPole = average(nonPoleData, 'DelayInQtn');
const avgWONonPole = average(nonPoleData, 'DelayInWO');
const avgSCNonPole = average(nonPoleData, 'DelayInSC');

// Set HTML with breakdown
document.getElementById('avgDelayQtn').innerHTML = `${avgQtn} <span class="text-muted" style="font-size: 0.9rem;">(${avgQtnPole}/${avgQtnNonPole})</span>`;
document.getElementById('avgDelayWO').innerHTML = `${avgWO} <span class="text-muted" style="font-size: 0.9rem;">(${avgWOPole}/${avgWONonPole})</span>`;
document.getElementById('avgDelaySC').innerHTML = `${avgSC} <span class="text-muted" style="font-size: 0.9rem;">(${avgSCPole}/${avgSCNonPole})</span>`;

// Commercial 3-Ph: CONN_CLASS = "A" and APPLIED_PHASE = "III"
const commercial3ph = filteredData.filter(d => {
  const conn = (d.CONN_CLASS || "").trim().toUpperCase();
  const phase = (d.APPLIED_PHASE || "").trim().toUpperCase();
  return conn === "A" && phase === "III";
}).length;

document.getElementById('commercial3ph').textContent = commercial3ph;

// Initially Withheld: SCN_WITHELD_DATE not blank/zero
const initiallyWithheld = filteredData.filter(d => {
  const date = d.SCN_WITHELD_DATE || "";
  return date.trim() !== "" && date.trim() !== "0";
}).length;

document.getElementById('initiallyWithheldCount').textContent = initiallyWithheld;
const percentOfTotal = filteredData.length ? ((initiallyWithheld / filteredData.length) * 100).toFixed(1) : 0;
document.getElementById('initiallyWithheldPercent').textContent = `(${percentOfTotal}% of Total)`;

    }

    // Show detailed table for selected filter
    function showTable(cardId, groupBy, filterFn, title) {
  const isMobile = window.innerWidth <= 768;

  if (isMobile) {
    const collapseId = cardId.replace('Card', 'Collapse');
    const tableContainerId = cardId.replace('Card', 'TableContainer');
    const collapseElement = document.getElementById(collapseId);
    const tableContainer = document.getElementById(tableContainerId);
    const bsCollapse = bootstrap.Collapse.getOrCreateInstance(collapseElement);

    const isCurrentlyOpen = collapseElement.classList.contains('show');

    if (isCurrentlyOpen) {
  bsCollapse.hide();
} else {
  // Close others first
  [
    'totalPendingCollapse',
    'nonPoleCollapse',
    'poleCollapse',
    'industrialPendingCollapse',
    'commercial3phCollapse'
  ].forEach(id => {
    if (id !== collapseId) {
      const el = document.getElementById(id);
      if (el && el.classList.contains('show')) {
        bootstrap.Collapse.getInstance(el).hide();
      }
    }
  });
       // âœ… Fill the table before expanding (since CSS will now allow smooth grow)
       fillTable(tableContainer, groupBy, filterFn, title);

  // Listen for when collapse is fully shown
  collapseElement.addEventListener('shown.bs.collapse', function handler() {
    fillTable(tableContainer, groupBy, filterFn, title);
    // Remove the event listener to prevent duplicate triggers
    collapseElement.removeEventListener('shown.bs.collapse', handler);
  });

  bsCollapse.show(); // trigger the animation
}


  } else {
    // Desktop behavior: shared table at bottom
    const collapseElement = document.getElementById('detailCollapse');
    const tableContainer = document.getElementById('detailTableContainer');
    const bsCollapse = bootstrap.Collapse.getOrCreateInstance(collapseElement);

    const isCurrentlyOpen = collapseElement.classList.contains('show');

    if (isCurrentlyOpen) {
      // If already open and clicking same card, collapse
      bsCollapse.hide();
    } else {
      fillTable(tableContainer, groupBy, filterFn, title);
      setTimeout(() => {
        bsCollapse.show();
      }, 10);
    }
  }
}



function fillTable(tableContainer, groupBy, filterFn, title) {
  const grouped = {};
  const filteredRecords = filteredData.filter(filterFn);

  if (filteredRecords.length === 0) {
    tableContainer.innerHTML = `
      <div class="card-body text-center p-5">
        <i class="fas fa-info-circle fa-3x mb-3 text-muted"></i>
        <h4>No Data Available</h4>
        <p class="text-muted">There are no records matching the selected filters.</p>
      </div>`;
    return;
  }

  filteredRecords.forEach(d => {
    const key = d[groupBy] || 'Unknown';
    grouped[key] = (grouped[key] || 0) + 1;
  });

  const sortedKeys = Object.keys(grouped).sort((a, b) => grouped[b] - grouped[a]);

  let html = `
    <div class="card-header bg-white py-3">
  <h5 class="mb-0 d-flex justify-content-between align-items-center">
  <span><i class="fas fa-table me-2"></i>${title}</span>
  <i class="fas fa-copy text-primary" title="Copy Table" style="cursor:pointer;" onclick="copyTableToWhatsApp(this)"></i>
</h5>

    </div>
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>${groupBy.replace('_', ' ')}</th>
            <th class="text-end">Count</th>
            <th class="text-end">%</th>
          </tr>
        </thead>
        <tbody>
  `;

  const total = filteredRecords.length;
  for (const key of sortedKeys) {
    const count = grouped[key];
    const percentage = ((count / total) * 100).toFixed(1);
    const rowId = `row-${groupBy}-${btoa(key).replace(/=/g, '')}`;


    html += `
      <tr class="expandable-row" data-group="${key}" data-rowid="${rowId}" style="cursor:pointer;">
        <td><i class="fas fa-chevron-right me-2"></i>${key}</td>
        <td class="text-end">${count}</td>
        <td class="text-end">${percentage}%</td>
      </tr>
      <tr id="${rowId}" class="sub-row" style="display:none; background:#f8f9fa;">
        <td colspan="3">
          <div id="${rowId}-subdata"></div>
        </td>
      </tr>
    `;
  }

  html += "</tbody></table></div>";
  tableContainer.innerHTML = html;

  // Add event listeners for toggle
  const rows = tableContainer.querySelectorAll(".expandable-row");
  rows.forEach(row => {
row.addEventListener("click", function(e) {
    e.stopPropagation(); // ðŸš¨ Important to prevent outer collapse
    const groupKey = this.dataset.group;
    const rowId = this.dataset.rowid;
    const subRow = document.getElementById(rowId);
    const icon = this.querySelector('i');

    if (subRow.style.display === "none") {
      if (
  title.includes('Industrial Pending') ||
  title.includes('Commercial 3-Ph') ||
  title.includes('Initially Withheld')
) {
  generateConsumerRows(groupKey, document.getElementById(`${rowId}-subdata`), groupBy, filterFn);
} else {
  generateSubRows(groupKey, document.getElementById(`${rowId}-subdata`), groupBy, filterFn);
}


  subRow.style.display = "";
        icon.classList.remove('fa-chevron-right');
        icon.classList.add('fa-chevron-down');
    } 
    
    else {
        subRow.style.display = "none";
        document.getElementById(`${rowId}-subdata`).innerHTML = "";
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-right');
    }
});

  });
}

function generateSubRows(groupKey, container, groupBy, filterFn) {
  const children = filteredData.filter(d => 
    filterFn(d) && (d[groupBy] === groupKey)
  );

  const groupedByCCC = {};
  children.forEach(d => {
    const ccc = d['SUPP_OFF'] || 'Unknown CCC';
    groupedByCCC[ccc] = (groupedByCCC[ccc] || 0) + 1;
  });

  const total = children.length;
  
  let html = `
<div class="d-flex justify-content-between align-items-center mb-1">
  <strong>CCC-wise Breakdown</strong>
  <i class="fas fa-copy text-primary" title="Copy This Table" style="cursor:pointer;" onclick="copyTableToWhatsApp(this)"></i>
</div>
<table class="table table-sm mb-0">

  <thead class="table-light">
    <tr>
      <th>CCC Name</th>
      <th class="text-end">Count</th>
      <th class="text-end">%</th>
    </tr>
  </thead>
  <tbody>
`;


const sortedCCC = Object.entries(groupedByCCC).sort((a, b) => b[1] - a[1]);
for (const [ccc, count] of sortedCCC) {
  const percentage = ((count / total) * 100).toFixed(1);
  html += `
    <tr>
      <td>${ccc}</td>
      <td class="text-end">${count}</td>
      <td class="text-end">${percentage}%</td>
    </tr>
  `;
}


  html += `</tbody></table>`;

  container.innerHTML = html;
}

function generateConsumerRows(groupKey, container, groupBy, filterFn) {
  const consumers = filteredData.filter(d => 
    filterFn(d) && (d[groupBy] === groupKey)
  );

  if (consumers.length === 0) {
    container.innerHTML = `<div class="text-center text-muted p-2">No consumer data found.</div>`;
    return;
  }
// Sort consumers by COLL_DATE (earliest first)
consumers.sort((a, b) => {
  const parseDate = str => {
    if (!str || str.trim() === '') return new Date(0);
    const [d, m, y] = str.trim().split(/[-/]/);
    return new Date(`20${y.length === 2 ? y : y.slice(-2)}`, m - 1, d);
  };
  return parseDate(a.COLL_DATE) - parseDate(b.COLL_DATE);
});

let html = `
<div class="d-flex justify-content-between align-items-center mb-1">
  <strong>Consumer List</strong>
  <i class="fas fa-copy text-primary" title="Copy Consumers" style="cursor:pointer;" onclick="copyTableToWhatsApp(this)"></i>
</div>
<table class="table table-sm table-bordered mb-0">

      <thead class="table-light">
        <tr>
          <th>APPL NO</th>
          <th>NAME</th>
          <th>PHONE NO</th>
          <th>COLL DATE</th>
          <th>AGENCY NAME</th>
        </tr>
      </thead>
      <tbody>
  `;
  function formatDate(dateStr) {
  const date = new Date(dateStr);
  if (isNaN(date)) return dateStr || '-';
  return date.toLocaleDateString('en-GB'); // dd/mm/yyyy
}

  consumers.forEach(d => {
    html += `
  <tr>
    <td>${d.APPL_NO || '-'}</td>
    <td>${d.NAME || '-'}</td>
    <td>${d.PHONE_NO || '-'}</td>
    <td>${formatDate(d.COLL_DATE)}</td>
    <td>${d.AGENCY_NAME && d.AGENCY_NAME.trim() !== "" ? d.AGENCY_NAME : '<span style="color:red;">WO not issued</span>'}</td>
  </tr>
`;

  });

  html += `</tbody></table>`;

  container.innerHTML = html;
}

// 1. First, modify the generateSubRowsForTabs function to add expandable rows for CCCs
function generateSubRowsForTabs(groupKey, container, groupByKey) {
  if (groupByKey === 'DelayRange2') {
  const delaySerialGroups = {
    "Within 3 days": [1],
    "More than 3 days": [2,3,4,5,6,7,8],
    "More than 7 days": [3,4,5,6,7,8],
    "More than 15 days": [4,5,6,7,8],
    "More than 1 month": [5,6,7,8],
    "More than 2 month": [6,7,8],
    "More than 6 month": [7,8],
    "More than 1 year": [8]
  };

  const allowedSerials = delaySerialGroups[groupKey] || [];
  const children = filteredData.filter(d => allowedSerials.includes(parseInt(d.DelaySerial)));

  const groupedByCCC = {};
  children.forEach(d => {
    const ccc = d['SUPP_OFF'] || 'Unknown CCC';
    if (!groupedByCCC[ccc]) {
      groupedByCCC[ccc] = {
        count: 0,
        applications: []
      };
    }
    groupedByCCC[ccc].count++;
    groupedByCCC[ccc].applications.push(d);
  });

  const total = children.length;
  let html = `
<div class="d-flex justify-content-between align-items-center mb-1">
  <strong>Application Details</strong>
  <i class="fas fa-copy text-primary" title="Copy Applications" style="cursor:pointer;" onclick="copyTableToWhatsApp(this)"></i>
</div>
<table class="table table-sm mb-0">

      <thead>
        <tr>
          <th>CCC Name</th> 
          <th class="text-end">Count</th>
          <th class="text-end">%</th>
        </tr>
      </thead>
      <tbody>
  `;

  const sortedCCC = Object.entries(groupedByCCC).sort((a, b) => b[1].count - a[1].count);
  for (const [ccc, data] of sortedCCC) {
    const count = data.count;
    const percent = total ? ((count / total) * 100).toFixed(1) : 0;
    const cccRowId = `ccc-${groupByKey}-${btoa(ccc).replace(/=/g, '')}`;

    html += `
      <tr class="expandable-ccc-row" data-ccc="${ccc}" data-rowid="${cccRowId}" style="cursor:pointer;">
        <td><i class="fas fa-chevron-right me-2"></i>${ccc}</td>
        <td class="text-end">${count}</td>
        <td class="text-end">${percent}%</td>
      </tr>
      <tr id="${cccRowId}" class="ccc-sub-row" style="display:none; background:#e9ecef;">
        <td colspan="3">
          <div id="${cccRowId}-subdata"></div>
        </td>
      </tr>
    `;
  }

  html += `</tbody></table>`;
  container.innerHTML = html;

  // âž• Expand to Consumer-level
  container.querySelectorAll('.expandable-ccc-row').forEach(row => {
    row.addEventListener('click', function(e) {
      e.stopPropagation();
      const ccc = this.dataset.ccc;
      const rowId = this.dataset.rowid;
      const subRow = document.getElementById(rowId);
      const icon = this.querySelector('i');

      if (subRow.style.display === "none") {
        const apps = groupedByCCC[ccc].applications;
        generateApplicationsTable(apps, document.getElementById(`${rowId}-subdata`));
        subRow.style.display = "";
        icon.classList.remove('fa-chevron-right');
        icon.classList.add('fa-chevron-down');
      } else {
        subRow.style.display = "none";
        document.getElementById(`${rowId}-subdata`).innerHTML = "";
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-right');
      }
    });
  });

  return;
}

  let children = [];

  if (groupByKey === 'PoleType') {
    // Special handling for Pole/Non-Pole case
    if (groupKey === 'Pole Cases') {
      children = filteredData.filter(d => (d.NO_OF_POLES || "").trim() !== "" && (d.NO_OF_POLES !== "0"));
    } else if (groupKey === 'Non-Pole Cases') {
      children = filteredData.filter(d => (d.NO_OF_POLES || "").trim() === "" || (d.NO_OF_POLES === "0"));
    }
  } else {
    // Normal case
    children = filteredData.filter(d => (d[groupByKey] || 'Not Specified') === groupKey);
  }

  const groupedByCCC = {};
  children.forEach(d => {
    const ccc = d['SUPP_OFF'] || 'Unknown CCC';
    if (!groupedByCCC[ccc]) {
      groupedByCCC[ccc] = {
        count: 0,
        applications: []
      };
    }
    groupedByCCC[ccc].count++;
    groupedByCCC[ccc].applications.push(d);
  });

  const total = children.length;
  let html = `
<div class="d-flex justify-content-between align-items-center mb-1">
  <strong>CCC-wise Details</strong>
  <i class="fas fa-copy text-primary" title="Copy This Table" style="cursor:pointer;" onclick="copyTableToWhatsApp(this)"></i>
</div>
<table class="table table-sm mb-0">

      <thead>
        <tr>
          <th>CCC Name</th>
          <th class="text-end">Count</th>
          <th class="text-end">%</th>
        </tr>
      </thead>
      <tbody>
  `;

  const sortedCCC = Object.entries(groupedByCCC).sort((a, b) => b[1].count - a[1].count);
  for (const [ccc, data] of sortedCCC) {
    const count = data.count;
    const percent = total ? ((count / total) * 100).toFixed(1) : 0;
    const cccRowId = `ccc-${groupByKey}-${btoa(ccc).replace(/=/g, '')}`;
    
    html += `
      <tr class="expandable-ccc-row" data-ccc="${ccc}" data-rowid="${cccRowId}" style="cursor:pointer;">
        <td><i class="fas fa-chevron-right me-2"></i>${ccc}</td>
        <td class="text-end">${count}</td>
        <td class="text-end">${percent}%</td>
      </tr>
      <tr id="${cccRowId}" class="ccc-sub-row" style="display:none; background:#e9ecef;">
        <td colspan="3">
          <div id="${cccRowId}-subdata"></div>
        </td>
      </tr>
    `;
  }

  html += `</tbody></table>`;
  container.innerHTML = html;
  
  // Add event listeners for CCC rows
  container.querySelectorAll('.expandable-ccc-row').forEach(row => {
    row.addEventListener('click', function(e) {
      e.stopPropagation();
      const ccc = this.dataset.ccc;
      const rowId = this.dataset.rowid;
      const subRow = document.getElementById(rowId);
      const icon = this.querySelector('i');
      
      if (subRow.style.display === "none") {
        // Get the applications for this CCC
        const apps = groupedByCCC[ccc].applications;
        const isFromAgencyTab = (groupByKey === 'AGENCY_NAME');
generateApplicationsTable(apps, document.getElementById(`${rowId}-subdata`), isFromAgencyTab);
        subRow.style.display = "";
        icon.classList.remove('fa-chevron-right');
        icon.classList.add('fa-chevron-down');
      } else {
        subRow.style.display = "none";
        document.getElementById(`${rowId}-subdata`).innerHTML = "";
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-right');
      }
    });
  });
}

// 2. Add new function to generate applications table
function generateApplicationsTable(applications, container, hideAgencyColumn = false) {
  if (applications.length === 0) {
    container.innerHTML = '<div class="text-center p-3 text-muted">No applications found</div>';
    return;
  }

  // Sort applications by COLL_DATE (earliest to latest)
  applications.sort((a, b) => {
    const dateA = a.COLL_DATE ? new Date(a.COLL_DATE) : new Date(0);
    const dateB = b.COLL_DATE ? new Date(b.COLL_DATE) : new Date(0);
    return dateA - dateB;
  });

  // Check if AGENCY_NAME exists in this context
  const showAgency = applications[0].AGENCY_NAME !== undefined && !hideAgencyColumn;

  let html = `
<div class="d-flex justify-content-between align-items-center mb-1">
  <strong>Application List</strong>
  <i class="fas fa-copy text-primary" title="Copy Applications" style="cursor:pointer;" onclick="copyTableToWhatsApp(this)"></i>
</div>
<table class="table table-sm mb-0">

      <thead>
        <tr>
          <th>APPL NO</th>
          <th>NAME</th>
          <th>PHONE NO</th>
          <th>COLL DATE</th>
          ${showAgency ? '<th>AGENCY NAME</th>' : ''}
        </tr>
      </thead>
      <tbody>
  `;

  applications.forEach(app => {
    const agency = (app.AGENCY_NAME || '').trim();
    const agencyCell = agency ? agency : '<span style="color:red;">WO not issued</span>';

    html += `
      <tr>
        <td>${app.APPL_NO || '-'}</td>
        <td>${app.NAME || '-'}</td>
        <td>${app.PHONE_NO || '-'}</td>
        <td>${app.COLL_DATE || '-'}</td>
        ${showAgency ? `<td>${agencyCell}</td>` : ''}
      </tr>
    `;
  });

  html += `</tbody></table>`;
  container.innerHTML = html;
}





document.getElementById('totalPendingCard').onclick = () => 
  showTable('totalPendingCard', 'DIVN_NAME', d => true, 'Pending NSC (Division Wise)');

document.getElementById('nonPoleCard').onclick = () => 
  showTable('nonPoleCard', 'DIVN_NAME', d => {
    const poles = d.NO_OF_POLES || "";
    return poles.trim() === "" || poles === "0";
  }, 'Non-Pole Case (Division Wise)');

document.getElementById('poleCard').onclick = () => 
  showTable('poleCard', 'DIVN_NAME', d => {
    const poles = d.NO_OF_POLES || "";
    return poles.trim() !== "" && poles !== "0";
  }, 'Pole Case (Division Wise)');

document.getElementById('industrialPendingCard').onclick = () => 
  showTable('industrialPendingCard', 'SUPP_OFF', d => {
    const connClass = (d.CONN_CLASS || "").trim().toUpperCase();
    return connClass === "I";
  }, 'Industrial Pending (CCC Wise)');

document.getElementById('commercial3phCard').onclick = () =>
  showTable('commercial3phCard', 'SUPP_OFF', d => {
    const conn = (d.CONN_CLASS || "").trim().toUpperCase();
    const phase = (d.APPLIED_PHASE || "").trim().toUpperCase();
    return conn === "A" && phase === "III";
  }, 'Commercial 3-Ph (CCC Wise)');

  document.getElementById('initiallyWithheldCard').onclick = () =>
  showTable('initiallyWithheldCard', 'SUPP_OFF', d => {
    const date = d.SCN_WITHELD_DATE || "";
    return date.trim() !== "" && date.trim() !== "0";
  }, 'Initially Withheld (CCC Wise)');


    // Filter change event handler
    document.getElementById('regionSelect').onchange = applyFilters;
document.getElementById('divnSelect').onchange = applyFilters;
document.getElementById('suppSelect').onchange = applyFilters;
document.getElementById('poleFilter').onchange = applyFilters;
document.getElementById('delayRangeFilter').onchange = applyFilters;
document.getElementById('delayRange2Filter').onchange = applyFilters;





    // Draw charts for data visualization
    function drawTables() {
  const chartColors = {}; // still unused, keeping for future
  
  const groupData = (key, defaultValue = 'Not Specified') => {
    const map = {};
    filteredData.forEach(d => {
      let value = d[key];
      if (!value || value.trim() === '') {
        value = defaultValue;
      }
      map[value] = (map[value] || 0) + 1;
    });
    return map;
  };
  const generateTable = (dataObj, header1, header2, groupByKey) => {
  const total = Object.values(dataObj).reduce((sum, val) => sum + val, 0);

  let html = `
    <div class="d-flex justify-content-between align-items-center mb-2">
      <strong>${header1} Summary</strong>
      <i class="fas fa-copy text-primary" title="Copy Table" style="cursor:pointer;" onclick="copyTableToWhatsApp(this)"></i>
    </div>
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>${header1}</th>
            <th class="text-end">${header2}</th>
            <th class="text-end">%</th>
          </tr>
        </thead>
        <tbody>
  `;



  let index = 0;
  for (const [key, value] of Object.entries(dataObj)) {
    const percent = total ? ((value / total) * 100).toFixed(1) : 0;
    const rowId = `tabrow-${groupByKey}-${btoa(key).replace(/=/g, '')}`;


    html += `
      <tr class="expandable-row" data-group="${key}" data-rowid="${rowId}" data-groupby="${groupByKey}" style="cursor:pointer;">
        <td><i class="fas fa-chevron-right me-2"></i>${key}</td>
        <td class="text-end">${value}</td>
        <td class="text-end">${percent}%</td>
      </tr>
      <tr id="${rowId}" class="sub-row" style="display:none; background:#fff3cd;">
        <td colspan="3">
          <div id="${rowId}-subdata"></div>
        </td>
      </tr>
    `;
    index++;
  }

  html += `</tbody></table></div>`;
  return html;
};

  const delayMap = {};
  filteredData.forEach(d => {
    const range = d.DelayRange || 'No Delay Data';
    const serial = parseInt(d.DelaySerial) || 0;
    if (!delayMap[range]) {
      delayMap[range] = { count: 0, serial: serial };
    }
    delayMap[range].count++;
  });
  const sortedDelay = Object.entries(delayMap)
    .sort((a, b) => b[1].serial - a[1].serial);

  const poleData = {
    'Pole Cases': filteredData.filter(d => (d.NO_OF_POLES || "").trim() !== "" && (d.NO_OF_POLES !== "0")).length,
    'Non-Pole Cases': filteredData.filter(d => (d.NO_OF_POLES || "").trim() === "" || (d.NO_OF_POLES === "0")).length
  };

  const duareData = Object.fromEntries(
  Object.entries(groupData('IS_DUARE_SARKAR', 'Not Specified')).sort((a, b) => b[1] - a[1])
);

  const woData = Object.fromEntries(
  Object.entries(groupData('WO_ISSUED', 'Not Issued')).sort((a, b) => b[1] - a[1])
);
const classData = Object.fromEntries(
  Object.entries(groupData('CONN_CLASS', 'Not Specified')).sort((a, b) => b[1] - a[1])
);

const agencyData = Object.fromEntries(
  Object.entries(groupData('AGENCY_NAME', 'WO not issued')).sort((a, b) => b[1] - a[1])
);
const delayRange2Buckets = {
  "Within 3 days": 0,
  "More than 3 days": 0,
  "More than 7 days": 0,
  "More than 15 days": 0,
  "More than 1 month": 0,
  "More than 2 month": 0,
  "More than 6 month": 0,
  "More than 1 year": 0,
};

filteredData.forEach(d => {
  const serial = parseInt(d.DelaySerial);
  if (serial === 1) delayRange2Buckets["Within 3 days"]++;
  if ([2,3,4,5,6,7,8].includes(serial)) delayRange2Buckets["More than 3 days"]++;
  if ([3,4,5,6,7,8].includes(serial)) delayRange2Buckets["More than 7 days"]++;
  if ([4,5,6,7,8].includes(serial)) delayRange2Buckets["More than 15 days"]++;
  if ([5,6,7,8].includes(serial)) delayRange2Buckets["More than 1 month"]++;
  if ([6,7,8].includes(serial)) delayRange2Buckets["More than 2 month"]++;
  if ([7,8].includes(serial)) delayRange2Buckets["More than 6 month"]++;
  if (serial === 8) delayRange2Buckets["More than 1 year"]++;
});
document.getElementById('delay2').querySelector('.chart-container').innerHTML = generateTable(
  delayRange2Buckets,
  'Range',
  'Count',
  'DelayRange2'
);

  // --- Generate tables with correct groupByKey ---
  document.getElementById('delay').querySelector('.chart-container').innerHTML = generateTable(
    Object.fromEntries(sortedDelay.map(([k, v]) => [k, v.count])), 
    'Range', 
    'Count',
    'DelayRange' // ðŸ‘ˆ important
  );

  document.getElementById('pole-data').querySelector('.chart-container').innerHTML = generateTable(
    poleData,
    'Type',
    'Count',
    'PoleType' // ðŸ‘ˆ dummy (since not actual column)
  );

  document.getElementById('duare').querySelector('.chart-container').innerHTML = generateTable(
    duareData,
    'DS?',
    'Count',
    'IS_DUARE_SARKAR'
  );

  document.getElementById('wo').querySelector('.chart-container').innerHTML = generateTable(
    woData,
    'Issued?',
    'Count',
    'WO_ISSUED'
  );

  document.getElementById('classwise').querySelector('.chart-container').innerHTML = generateTable(
    classData,
    'Class',
    'Count',
    'CONN_CLASS'
  );
  document.getElementById('agency').querySelector('.chart-container').innerHTML = generateTable(
  agencyData,
  'Agency',
  'Count',
  'AGENCY_NAME'
);

  // --- Attach expandable click listeners after building tables ---
  document.querySelectorAll('.expandable-row').forEach(oldRow => {
  const newRow = oldRow.cloneNode(true);  // deep clone
  oldRow.replaceWith(newRow);  // replace old with new

  newRow.addEventListener('click', function(e) {
    e.stopPropagation();
    const groupKey = this.dataset.group;
    const rowId = this.dataset.rowid;
    const groupByKey = this.dataset.groupby;

    const subRow = document.getElementById(rowId);
    const icon = this.querySelector('i');

    if (subRow.style.display === "none") {
      generateSubRowsForTabs(groupKey, document.getElementById(`${rowId}-subdata`), groupByKey);
      subRow.style.display = "";
      icon.classList.remove('fa-chevron-right');
      icon.classList.add('fa-chevron-down');
    } else {
      subRow.style.display = "none";
      document.getElementById(`${rowId}-subdata`).innerHTML = "";
      icon.classList.remove('fa-chevron-down');
      icon.classList.add('fa-chevron-right');
    }
  });
});

}

    
    document.addEventListener('DOMContentLoaded', () => {
  ['totalPendingCollapse', 'nonPoleCollapse', 'poleCollapse', 'industrialPendingCollapse', 'detailCollapse'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.classList.remove('show');
    }
  });
});
document.addEventListener('DOMContentLoaded', () => {
  ['totalPendingCollapse', 'nonPoleCollapse', 'poleCollapse', 'industrialPendingCollapse', 'detailCollapse'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.classList.remove('show');
    }
  });

  // ðŸ”½ Add this block BELOW
  document.querySelectorAll('.collapse').forEach(collapse => {
    collapse.addEventListener('shown.bs.collapse', (e) => {
      const id = e.target.id;
      const map = {
        totalPendingCollapse: {
          cardId: 'totalPendingCard',
          groupBy: 'DIVN_NAME',
          filterFn: d => true,
          title: 'Pending NSC (Division Wise)'
        },
        
        nonPoleCollapse: {
          cardId: 'nonPoleCard',
          groupBy: 'DIVN_NAME',
          filterFn: d => (d.NO_OF_POLES || "").trim() === "" || d.NO_OF_POLES === "0",
          title: 'Non-Pole Case (Division Wise)'
        },
        poleCollapse: {
          cardId: 'poleCard',
          groupBy: 'DIVN_NAME',
          filterFn: d => (d.NO_OF_POLES || "").trim() !== "" && d.NO_OF_POLES !== "0",
          title: 'Pole Case (Division Wise)'
        },
        industrialPendingCollapse: {
          cardId: 'industrialPendingCard',
          groupBy: 'SUPP_OFF',
          filterFn: d => (d.CONN_CLASS || "").trim().toUpperCase() === "I",
          title: 'Industrial Pending (CCC Wise)'
        },
        commercial3phCollapse: {
          cardId: 'commercial3phCard',
          groupBy: 'SUPP_OFF',
          filterFn: d => {
            const conn = (d.CONN_CLASS || "").trim().toUpperCase();
            const phase = (d.APPLIED_PHASE || "").trim().toUpperCase();
            return conn === "A" && phase === "III";
          },
          title: 'Commercial 3-Ph (CCC Wise)'
        },
        initiallyWithheldCollapse: {
  cardId: 'initiallyWithheldCard',
  groupBy: 'SUPP_OFF',
  filterFn: d => (d.SCN_WITHELD_DATE || "").trim() !== "" && d.SCN_WITHELD_DATE.trim() !== "0",
  title: 'Initially Withheld (CCC Wise)'
}

        
      };

      const cfg = map[id];
      if (cfg) {
        const tableContainerId = cfg.cardId.replace('Card', 'TableContainer');
        const container = document.getElementById(tableContainerId);
        fillTable(container, cfg.groupBy, cfg.filterFn, cfg.title);
      }
    });
  });
});

    // Initialize the dashboard
    fetchData();

    function copyTableToWhatsApp(iconElement) {
  // Wait briefly to ensure the table is rendered
  setTimeout(() => {
    const wrapper = iconElement.closest('.d-flex');
    if (!wrapper) return alert("No header found near icon.");

    // âœ… Find the nearest card or tab-pane
    let cardOrTab = iconElement.closest('.card, .tab-pane, .chart-container');
    let table = cardOrTab?.querySelector('table');

    if (!table) return alert("No table found to copy.");

    const currentTableTitle = wrapper.querySelector('strong')?.innerText?.trim() || 'Details';

    // Detect mode (card or tab)
    let contextParts = [];
    let mode = 'card';

    const tabPane = iconElement.closest('.tab-pane');
    if (tabPane) {
      mode = 'tab';
      const tabId = tabPane.id;
      const tabBtn = document.querySelector(`.nav-link[data-bs-target="#${tabId}"]`);
      const tabName = tabBtn?.innerText.trim() || 'Tab';
      contextParts.push(tabName);
    }

    let current = wrapper.parentElement;
    let foundCardName = '', foundSubtableHeader = '';

    while (current && current !== document.body) {
      if (mode === 'card') {
        const cardTitle = current.querySelector('.card-header h5, .card-title strong, h5.card-title');
        if (cardTitle) {
          const cardText = cardTitle.innerText.trim();
          if (!foundCardName) foundCardName = cardText;
          else if (!foundSubtableHeader && cardText !== foundCardName) foundSubtableHeader = cardText;
        }
      }

      const possibleRow = current.closest('tr')?.previousElementSibling;
      if (possibleRow && possibleRow.matches('tr.expandable-row, tr.expandable-ccc-row')) {
        const td = possibleRow.querySelector('td');
        if (td) {
          const rowText = td.innerText.trim().replace(/^[â–ºâ–¼]\s*/, '');
          if (rowText && !contextParts.includes(rowText)) {
            contextParts.push(rowText);
          }
        }
      }

      current = current.parentElement;
    }

    if (mode === 'card') {
      const fullParts = [foundCardName, foundSubtableHeader, ...contextParts.reverse(), currentTableTitle];
      contextParts = fullParts.filter(Boolean);
    } else if (mode === 'tab') {
      contextParts.push(currentTableTitle);
    }

    const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.innerText.trim());
    const rows = Array.from(table.querySelectorAll('tbody tr'));
    const headerLine = headers.join(' | ');
    const rowLines = rows.map(row =>
      Array.from(row.querySelectorAll('td')).map(td => td.innerText.trim()).join(' | ')
    );

    const topLine = '*Pending NSC:*';
    const finalText = `${topLine}\nðŸ“‹ ${contextParts.join(': ')}\n${headerLine}\n${rowLines.join('\n')}`;
    showModalWithOutput(finalText);
  }, 100); // small delay for render
}








function shortHeader(header) {
  const map = {
    'Division Name': 'Division',
    'CCC Name': 'CCC',
    'Count': 'Cnt',
    '%': '%',
    'APPL NO': 'App',
    'NAME': 'Name',
    'PHONE NO': 'Ph',
    'COLL DATE': 'Date',
    'AGENCY NAME': 'Agency',
    'Issued?': 'WO',
    'DS?': 'DS',
    'Range': 'Delay'
  };
  return map[header.trim().toUpperCase()] || header.trim();
}

function showModalWithOutput(text) {
  document.getElementById("modalOutput").value = text;
  document.getElementById("copyModal").style.display = "flex";
}

function hideModal() {
  document.getElementById("copyModal").style.display = "none";
}

function copyFromModal() {
  const textarea = document.getElementById("modalOutput");
  textarea.select();
  document.execCommand("copy");
  alert("Copied!");
}



  </script>

<!-- Manual Copy Modal -->
<div class="modal" id="copyModal" style="display:none;">
  <div class="modal-content">
    <span class="modal-close" onclick="hideModal()"><i class="fas fa-times"></i></span>
    <h3>Copy Output</h3>
    <textarea id="modalOutput" readonly style="width:100%; height:200px; margin-top:10px; font-size:0.9rem; padding:10px;"></textarea>
    <button onclick="copyFromModal()" style="margin-top:10px;" class="btn btn-primary">Copy</button>
  </div>
</div>


</body>
</html>
